---
title: "ggplot2"
subtitle: "Options, packages and examples for PDF print"
mainfont: "Verdana"
author: "Fabian Koch"
header-includes:
  - \setlength{\columnsep}{18pt}
  - \usepackage{multicol}
  - \newcommand{\hideFromPandoc}[1]{#1} # https://stackoverflow.com/questions/40982836/latex-multicolumn-block-in-pandoc-markdown
  - \hideFromPandoc{
      \let\Begin\begin
      \let\End\end
      }
output: 
  pdf_document: 
    keep_tex: true
    latex_engine: "xelatex"

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



```{r message=FALSE}
library(tidyverse) # import/wrangle
library(ggplot2) # plot/maps
library(tmap) # Dataset/Maps
library(viridis) # palettes
```


```{r}
data("World")

# Data mit geometry
WorldGeom <- World
# Data ohne
WorldData <- World %>% 
  sf::st_drop_geometry()
```
\newpage



Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. 

vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.

# ggplot2
## Themes

https://ggplot2.tidyverse.org/reference/theme.html


```{r}




PAL_Gliederung_Colour <- c(SR = "blue", UBZTP = "orange")
PAL_Gebiet_fill <- c("yellow3", "black", "grey", "maroon3") 
PAL_pal9GnPu <- c("#762a83", "#9970ab", "#c2a5cf", "#e7d4e8", "#f7f7f7", "#d9f0d3", "#a6dba0", "#5aae61", "#1b7837")
PAL_virpal <- viridisLite::viridis(6)
PAL_col6qual <- c("#66c2a5","#fc8d62","#8da0cb","#e78ac3","#a6d854","#ffd92f")


# Thema für Karten in ggplot
# default_font_family <- "sans" entfällt wegen Latex settings
default_font_color <- "black"
default_background_color <- "white"

theme_map <- function(...) {
  theme_minimal()
  theme(
    text = element_text(
      # family = default_font_family,
      color = default_font_color),
    # remove all axes
    axis.line = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks = element_blank(),
    # add a subtle grid
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    # background colors
    plot.background = element_rect(fill = default_background_color,
                                   color = NA),
    panel.background = element_rect(fill = default_background_color,
                                    color = NA),
    legend.background = element_rect(fill = default_background_color,
                                     color = NA),
    # borders and margins
    plot.margin = unit(c(0.1, -0.2, -0.3, -0.3), "cm"),
    panel.border = element_blank(),
    panel.spacing = unit(c(0, 0, 0, 0), "cm"),
    # titles
    legend.title = element_text(size = 7),
    legend.text = element_text(size = 7, hjust = 0,
                               color = default_font_color),
    plot.title = element_text(size = 20, 
                              color = default_font_color,
                              face = "bold"),
    plot.subtitle = element_text(size = 15, 
                                 color = default_font_color,
                                 margin = margin(b = -0.1,
                                                 t = -0.1,
                                                 l = 2,
                                                 unit = "cm"),
                                 debug = F),
    # captions
    plot.caption = element_text(size = 10,
                                hjust = 0,
                                margin = margin(t = 0.2,
                                                b = 0,
                                                unit = "cm"),
                                color = "#939184"),
    ...
  )
}



```

```{r }
    # labs(
    #   title = "Titel",
    #   subtitle = "Untertitel",
    #   caption = "Fußnote",
    #   tag = "label",
    #   fill = "Titel Legende") +
    # xlab("Beschriftung x") +
    # ylab("Beschriftung y") +
```


\newpage

```{r}
mapData <- WorldGeom %>% 
  select(
    name,
    continent,
    pop_est,
    income_grp,
    geometry) %>% 
  filter(continent == "Asia") %>% 
  mutate(
    # Vereinigung der 5 Kategorien zu 3
    income_grp = forcats::fct_collapse(income_grp,
      Hoch = c("1. High income: OECD", "2. High income: nonOECD"),
      Mittel = c("3. Upper middle income", "4. Lower middle income"),
      Niedrig = c("5. Low income")))
  
  ggplot() +
    # da das data.frame eine geometry Spalte besitzt, kommt geom_sf ohne x und y bzw. Rechts- und Hochwerte aus
    # data.frames mit Rechts- und Hochwerten können über sf::st_as_sf in dieses Format konvertiert werden
    # https://www.rdocumentation.org/packages/sf/versions/0.9-7/topics/st_as_sf
    # https://r-spatial.github.io/sf/reference/st_as_sf.html
    geom_sf(
      data = mapData, 
      aes(fill = income_grp)) +
    # Externe Farbpalette, Beispiel viridis
    # https://www.rdocumentation.org/packages/viridis/versions/0.5.1/topics/scale_color_viridis
    viridis::scale_fill_viridis(
      # Diskrete Variable (Einkommensgruppen)
      discrete = TRUE,
      # Umkehr der Palette, damit dunkel = Niedrig
      direction = -1) +
    # ggrepel ist ein package, das Beschriftungen oder Labels so ausrichtet, dass es zu keinen Überlappungen kommmt
    ggrepel::geom_label_repel(
      # man kann die ausgewählte Variable mit subset filtern
      data = subset(mapData, income_grp == "Niedrig"), 
      # ohne stat = "sf_coordinates" kann ggrepel keine "geometry" Angaben verarbeiten
      stat = "sf_coordinates",
      aes(
        geometry = geometry,
        label = name)) +
    # siehe theme settings oben
    theme_map() +
    labs(
      title = "Titel",
      subtitle = "Untertitel",
      caption = "Fußnote",
      tag = "label",
      fill = "Titel Legende") +
    xlab("Beschriftung x") +
    ylab("Beschriftung y") 


```


# Gemischtes 1 und 2 Spalten Layout

\Begin{multicols}{2}
```{r echo = FALSE}
# Data 
mapData <- WorldGeom %>% 
  select(
    name,
    continent,
    pop_est,
    income_grp,
    geometry) %>% 
  filter(continent == "Asia") %>% 
  mutate(
    # Vereinigung der 5 Kategorien zu 3
    income_grp = forcats::fct_collapse(income_grp,
      Hoch = c("1. High income: OECD", "2. High income: nonOECD"),
      Mittel = c("3. Upper middle income", "4. Lower middle income"),
      Niedrig = c("5. Low income")))
  
  ggplot() +
    # da das data.frame eine geometry Spalte besitzt, kommt geom_sf ohne x und y bzw. Rechts- und Hochwerte aus
    # data.frames mit Rechts- und Hochwerten können über sf::st_as_sf in dieses Format konvertiert werden
    # https://www.rdocumentation.org/packages/sf/versions/0.9-7/topics/st_as_sf
    # https://r-spatial.github.io/sf/reference/st_as_sf.html
    geom_sf(
      data = mapData, 
      aes(fill = income_grp)) +
    # Externe Farbpalette, Beispiel viridis
    # https://www.rdocumentation.org/packages/viridis/versions/0.5.1/topics/scale_color_viridis
    viridis::scale_fill_viridis(
      # Diskrete Variable (Einkommensgruppen)
      discrete = TRUE,
      # Umkehr der Palette, damit dunkel = Niedrig
      direction = -1) +
    # ggrepel ist ein package, das Beschriftungen oder Labels so ausrichtet, dass es zu keinen Überlappungen kommmt
    ggrepel::geom_label_repel(
      # man kann die ausgewählte Variable mit subset filtern
      data = subset(mapData, income_grp == "Niedrig"), 
      # ohne stat = "sf_coordinates" kann ggrepel keine "geometry" Angaben verarbeiten
      stat = "sf_coordinates",
      aes(
        geometry = geometry,
        label = name)) +
    theme(
      legend.position = "top",
      # keine Achsenlinien
      axis.line=element_blank(),
      # keine Achsentitel
      axis.title.x=element_blank(),
      axis.title.y=element_blank(),
      # keine Achsen-Markierungen
      axis.ticks=element_blank(),
      # kein Achsentext
      axis.text.x=element_blank(),
      axis.text.y=element_blank(),
      # kein Hintergrund
      panel.background=element_blank(),
      # kein Hilfslinien
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      # kein Hintergrund
      plot.background=element_blank())

```
Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. 
\columnbreak

```{r echo = FALSE}
WorldData %>% 
  select(
    name,
    pop_est) %>% 
  arrange(desc(pop_est)) %>% 
  head(5) %>% 
  ggplot() + 
  geom_col(aes(x = pop_est, y = forcats::fct_reorder(name, pop_est))) +
  xlab("Bevölkerung") +
  ylab("") +
  theme(axis.text=element_text(size=12),
        axis.title=element_text(size=14,face="bold"))

```
Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. 

\End{multicols}

```{r echo = FALSE}
# Manuelle Farbpalette
PAL_well <- c("#fc8d62","#e78ac3","#66c2a5", "#8da0cb","#a6d854","#ffd92f","#e5c494")

WorldData %>% 
    select(
    name,
    continent,
    inequality,
    well_being,
    gdp_cap_est,
    economy) %>% 
  group_by(
    continent) %>% 
  mutate(avg_gdp = mean(gdp_cap_est, na.rm = TRUE)) %>% 
  ungroup() %>% 
  drop_na() %>% 
  mutate(
    # Vereinigung der Kategorien
    economy = forcats::fct_collapse(economy,
      "entwickelt" = c("1. Developed region: G7", "2. Developed region: nonG7"),
      "aufstrebend" = c("3. Emerging region: BRIC", "4. Emerging region: MIKT", "5. Emerging region: G20"),
      "nicht-entwickelt" = c("6. Developing region", "7. Least developed region"))) %>% 
  ggplot() +
  geom_point(
    aes(
      inequality, 
      well_being,
    colour = fct_reorder(continent, desc(avg_gdp))),
    alpha = 0.8) + 
  facet_wrap(
    ~ economy, 
    nrow = 2) +
  scale_colour_manual(
    values = PAL_well,
    guide = guide_legend(
                      title.position = "top",
                      title="Kontinente",
                      direction="horizontal",
                      nrow = 3,
                      ncol = 2)) +
  geom_smooth(aes(x = inequality, y = well_being), method = "lm") +
  theme_minimal() +
  xlab("Wohlbefinden") +
  ylab("Ungleichheit") +
  theme(
    # Legenden Position, Alternativ: "top", "bottom", "right", "left"
    legend.position = c(0.72, 0.27),
    # Legenden Schrift fett
    legend.title = element_text(face="bold"),
    # Abstand der Achsentitel zum Achsentext
    axis.title.x = element_text(margin = margin(t = 15, r = 0, b = 0, l = 0)),
    axis.title.y = element_text(margin = margin(t = 0, r = 15, b = 0, l = 0)))

```